<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typical RNG Calculator</title>
    <style>
        /* Global styles */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f8f9fa;
            color: #333;
        }
        
        /* Layout */
        .container { 
            display: grid; 
            grid-template-columns: 380px 1fr; 
            gap: 25px; 
            align-items: start;
        }
        .input-section { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
        }
        .results-section { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 800px;
        }
        
        /* Form elements */
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #555;
        }
        input, select, textarea { 
            width: 100%; 
            padding: 10px 12px; 
            border: 2px solid #e1e5e9; 
            border-radius: 6px; 
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #007bff;
            outline: none;
        }
        
        /* Buttons */
        button { 
            background: #007bff; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s;
        }
        button:hover { background: #0056b3; }
        .btn-full { width: 100%; }
        .btn-small { 
            padding: 6px 12px; 
            font-size: 14px; 
            margin: 2px;
        }
        
        /* Results display */
        .result-card { 
            background: white; 
            border: 1px solid #e1e5e9; 
            border-radius: 8px; 
            padding: 20px; 
            margin: 15px 0; 
        }
        .progress-bar { 
            background: #e9ecef; 
            border-radius: 10px; 
            overflow: hidden; 
            height: 20px; 
            margin: 5px 0;
        }
        .progress-fill { 
            background: linear-gradient(90deg, #4CAF50, #45a049); 
            height: 100%; 
            transition: width 0.3s; 
        }
        
        /* Sans lists */
        .sans-list { max-height: 500px; overflow-y: auto; }
        .sans-item { 
            padding: 12px; 
            border-bottom: 1px solid #f1f3f4; 
            transition: background 0.2s;
        }
        .sans-item:hover { background: #f8f9fa; }
        
        /* Badges for special sans types */
        .raw-badge { 
            background: #dc3545; 
            color: white; 
            padding: 3px 8px; 
            border-radius: 4px; 
            font-size: 0.75em; 
            margin-left: 8px;
        }
        .blacklisted-badge { 
            background: #6c757d; 
            color: white; 
            padding: 3px 8px; 
            border-radius: 4px; 
            font-size: 0.75em; 
            margin-left: 8px;
        }
        
        /* Search functionality */
        .search-container { position: relative; }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
        }
        .search-result-item:hover {
            background: #007bff;
            color: white;
        }
        
        /* Selected sans display */
        .selected-sans {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        .selected-sans-item {
            background: #e9ecef;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .remove-sans {
            cursor: pointer;
            color: #dc3545;
            font-weight: bold;
        }
        
        /* Statistics grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 0.9em;
            color: #666;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e5e9;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        
        /* Save button container - FIXED POSITION */
        .save-button-container {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 15px 0 0 0;
            margin-top: 20px;
            border-top: 1px solid #e1e5e9;
        }
        
        /* Help icons */
        .help-icon {
            color: #6c757d;
            cursor: pointer;
            margin-left: 8px;
            font-size: 0.9em;
        }
        .help-icon:hover {
            color: #007bff;
        }
        
        /* Checkbox grids for configuration modals */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 60vh;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
        }
        
        /* Control rows for bulk actions */
        .controls-row {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            border-top: 1px solid #e1e5e9;
        }
        .donate-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
        }
        .donate-link:hover {
            text-decoration: underline;
        }
        
        /* Typography */
        h1 { color: #2c3e50; margin-bottom: 10px; }
        h2 { color: #34495e; margin: 25px 0 15px 0; }
        h3 { color: #2c3e50; margin: 20px 0 12px 0; }
        h4 { color: #495057; margin: 15px 0 10px 0; }
    </style>
</head>
<body>
    <!-- Main header -->
    <h1>Typical RNG Calculator</h1>
    <p style="color: #666; margin-bottom: 30px;">Calculate expected values and probabilities for Typical RNG game</p>
    
    <!-- Main content container -->
    <div class="container">
        <!-- Input section with configuration options -->
        <div class="input-section">
            <h3>Calculator Settings</h3>
            
            <!-- Server luck multiplier input -->
            <div class="form-group">
                <label>Server Luck Multiplier:</label>
                <input type="number" id="server_luck" value="8" min="1" max="100">
            </div>
            
            <!-- Time period input -->
            <div class="form-group">
                <label>Time Period (seconds):</label>
                <input type="number" id="time_seconds" value="3600" min="1">
            </div>
            
            <!-- Unobtainable sans configuration -->
            <div class="form-group">
                <label>
                    Unobtainable Sans List
                    <span class="help-icon" onclick="openModal('unobtainableHelpModal')">?</span>
                </label>
                <button type="button" onclick="openModal('unobtainableModal')" class="btn-full">Configure Unobtainable Sans</button>
            </div>
            
            <!-- Blacklist sans configuration -->
            <div class="form-group">
                <label>
                    Blacklist Sans (Hide from results)
                    <span class="help-icon" onclick="openModal('blacklistHelpModal')">?</span>
                </label>
                <button type="button" onclick="openModal('blacklistedModal')" class="btn-full">Configure Blacklist</button>
            </div>
            
            <!-- Raw sans configuration -->
            <div class="form-group">
                <label>
                    Custom Raw Sans(!luck)
                    <span class="help-icon" onclick="openModal('rawModal')">?</span>
                </label>
                <button type="button" onclick="openModal('rawModal')" class="btn-full">Configure Raw Sans(!luck)</button>
            </div>
            
            <!-- Sans selection for detailed analysis -->
            <div class="form-group">
                <label>Select Sans to Analyze:</label>
                <div class="search-container">
                    <input type="text" id="sans_search" placeholder="Search sans...">
                    <div class="search-results" id="search_results"></div>
                </div>
                <div class="selected-sans" id="selected_sans"></div>
            </div>
            
            <!-- Custom sans input -->
            <div class="form-group">
                <label>
                    Custom Sans
                    <span class="help-icon" onclick="openModal('customHelpModal')">?</span>
                </label>
                <textarea id="custom_sans" rows="4" placeholder='{"CustomSans": 1000}'></textarea>
            </div>
            
            <!-- Calculate button -->
            <button onclick="calculate()" class="btn-full">Calculate Expectations</button>
        </div>
        
        <!-- Results display section -->
        <div class="results-section" id="results">
            <h3>Calculation Results</h3>
            <!-- Loading indicator -->
            <div id="loading" style="display: none; text-align: center; padding: 40px;">
                <div style="font-size: 1.2em; margin-bottom: 10px;">Calculating...</div>
                <div style="color: #666;">This may take a few seconds</div>
            </div>
            <!-- Results content container -->
            <div id="results-content"></div>
        </div>
    </div>
    
    <!-- Footer with creator info and donation link -->
    <div class="footer">
        <p>Created by <strong>@tux_koh</strong></p>
        <p>
            <a href="https://www.roblox.com/game-pass/1540670718/donation" 
               target="_blank" 
               class="donate-link">
                donate me 10 bobux :D
            </a>
        </p>
        <p>guys what should i do if my first donation from TR coder</p>
    </div>

    <!-- Unobtainable Sans Modal -->
    <div id="unobtainableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Unobtainable Sans Configuration</h3>
                <span class="close" onclick="closeModal('unobtainableModal')">&times;</span>
            </div>
            <p>Select which sans should be unobtainable (will not spawn):</p>
            
            <div class="controls-row">
                <button type="button" onclick="selectAllUnobtainable()" class="btn-small">Select All</button>
                <button type="button" onclick="deselectAllUnobtainable()" class="btn-small">Deselect All</button>
                <button type="button" onclick="invertUnobtainableSelection()" class="btn-small">Invert Selection</button>
            </div>
            
            <div class="search-container">
                <input type="text" id="unobtainable_search" placeholder="Search sans..." oninput="filterUnobtainableSans()">
            </div>
            
            <div class="checkbox-grid" id="unobtainable_checkboxes">
                <!-- Dynamically populated by JavaScript -->
            </div>
            
            <!-- Fixed Save Button Container -->
            <div class="save-button-container">
                <button type="button" onclick="saveUnobtainableSettings()" class="btn-full">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Blacklisted Sans Modal -->
    <div id="blacklistedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Blacklist Sans Configuration</h3>
                <span class="close" onclick="closeModal('blacklistedModal')">&times;</span>
            </div>
            <p>Select which sans should be hidden from results (does not affect probabilities):</p>
            
            <div class="controls-row">
                <button type="button" onclick="selectAllBlacklisted()" class="btn-small">Select All</button>
                <button type="button" onclick="deselectAllBlacklisted()" class="btn-small">Deselect All</button>
                <button type="button" onclick="invertBlacklistedSelection()" class="btn-small">Invert Selection</button>
            </div>
            
            <div class="search-container">
                <input type="text" id="blacklisted_search" placeholder="Search sans..." oninput="filterBlacklistedSans()">
            </div>
            
            <div class="checkbox-grid" id="blacklisted_checkboxes">
                <!-- Dynamically populated by JavaScript -->
            </div>
            
            <!-- Fixed Save Button Container -->
            <div class="save-button-container">
                <button type="button" onclick="saveBlacklistedSettings()" class="btn-full">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Raw Sans Modal -->
    <div id="rawModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Custom Raw Sans(!luck) Configuration</h3>
                <span class="close" onclick="closeModal('rawModal')">&times;</span>
            </div>
            <p>Select which sans should be treated as RAW (not affected by server luck):</p>
            
            <div class="controls-row">
                <button type="button" onclick="selectAllRaw()" class="btn-small">Select All</button>
                <button type="button" onclick="deselectAllRaw()" class="btn-small">Deselect All</button>
                <button type="button" onclick="invertRawSelection()" class="btn-small">Invert Selection</button>
            </div>
            
            <div class="search-container">
                <input type="text" id="raw_search" placeholder="Search sans..." oninput="filterRawSans()">
            </div>
            
            <div class="checkbox-grid" id="raw_checkboxes">
                <!-- Dynamically populated by JavaScript -->
            </div>
            
            <!-- Fixed Save Button Container -->
            <div class="save-button-container">
                <button type="button" onclick="saveRawSettings()" class="btn-full">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Help Modals -->
    <div id="unobtainableHelpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Unobtainable Sans</h3>
                <span class="close" onclick="closeModal('unobtainableHelpModal')">&times;</span>
            </div>
            <p>These sans are completely removed from the spawn pool and will never appear.</p>
            <p>Default unobtainable sans: CTI (corrupted true insanity), clown, undersanity, roland</p>
            <button type="button" onclick="closeModal('unobtainableHelpModal')" class="btn-full">Close</button>
        </div>
    </div>

    <div id="blacklistHelpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Blacklist Sans</h3>
                <span class="close" onclick="closeModal('blacklistHelpModal')">&times;</span>
            </div>
            <p>These sans are hidden from results but still affect probabilities.</p>
            <p>Example: If Little (1/2) is blacklisted and Classic (1/2) is not, Little will be hidden from results but the total probability remains 1/2.</p>
            <button type="button" onclick="closeModal('blacklistHelpModal')" class="btn-full">Close</button>
        </div>
    </div>

    <div id="customHelpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Custom Sans - How to Use</h3>
                <span class="close" onclick="closeModal('customHelpModal')">&times;</span>
            </div>
            <p><strong>Format:</strong> JSON object with sans names as keys and chance values as numbers</p>
            <p><strong>Example:</strong></p>
            <pre style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
{
    "MyCustomSans": 1000,
    "AnotherSans": 5000,
    "RareSans": 10000
}</pre>
            <p><strong>Notes:</strong></p>
            <ul>
                <li>Chance values work the same as default sans</li>
                <li>Custom sans will be added to the existing list</li>
                <li>Duplicate names will overwrite default values</li>
                <li>To make custom sans RAW, use the Raw Sans configuration</li>
            </ul>
            <button type="button" onclick="closeModal('customHelpModal')" class="btn-full">Close</button>
        </div>
    </div>

    <script>
        // Default sans data with fixed name consistency
        const DEFAULT_SANS_DATA = {
            "Little": 2, "classic": 3, "Fell": 5, "outer": 8, "horror": 25,
            "Fresh": 32, "After": 44, "Killer": 66, "Dream": 77, "RuinsDust": 12,
            "SnowdinDust": 20, "Photo Negative": 200, "Assured Prey": 500, "gencide": 900,
            "C!insanity": 3666, "Avenge": 3449, "Ink": 5000, "Error": 5000, "Fatal error": 55555,
            "Reaper": 99999, "Pesti": 3500, "DD (dustdust)": 16666, "Lethal Deal": 50000, "Hyper-dust": 99999,
            "clown": 69420, "undersanity": 500000, "Corrupted insanity": 162162, "Final insanity": 241956,
            "Superfell": 250000, "Cone": 100000, "Weakened alpha": 250000, "king mutiverse": 333333,
            "zalgo": 366666, "error404": 404040, "omnipotent": 555555, "infected": 666666,
            "fatal corruption": 666666, "virus404": 999999, "HIM (true insanity)": 1666666,
            "alpha judge": 399999, "errordust": 444444, "true dust": 500000, "Shanghaivania": 1500000,
            "lulzsec": 777777, "containment": 800000, "negative error404": 1404040, "omnithorn": 2222220,
            "DDD (dustdustdust)": 2666666, "final dust": 2999999, "butterfly404": 4040404, "error666": 6666666,
            "overkill": 16000000, "loading": 2222222, "code rainbow": 2222222, "distortion": 3666666,
            "entity0": 11111111, "anti god": 6000000, "CTI (corrupted true insanity)": 15000000,
            "roland": 15000000
        };

        // Application state
        let selectedSans = new Set(); // Sans selected for detailed analysis
        let unobtainableSans = new Set(['CTI (corrupted true insanity)', 'clown', 'undersanity', 'roland', 'anti god']); // Cannot spawn
        let blacklistedSans = new Set([]); // Hidden from results but affect probabilities
        let rawSans = new Set(['CTI (corrupted true insanity)', 'negative error404', 'anti god']); // Not affected by server luck
        const allSans = Object.keys(DEFAULT_SANS_DATA); // All available sans names
        
        // Initialize modals when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeUnobtainableModal();
            initializeBlacklistedModal();
            initializeRawModal();
        });
        
        // Initialize unobtainable sans modal with checkboxes
        function initializeUnobtainableModal() {
            const container = document.getElementById('unobtainable_checkboxes');
            if (!container) return;
            
            container.innerHTML = '';
            
            allSans.forEach(sans => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                const safeId = 'unobtainable_' + sans.replace(/[^a-zA-Z0-9]/g, '_');
                div.innerHTML = `
                    <input type="checkbox" id="${safeId}" ${unobtainableSans.has(sans) ? 'checked' : ''}>
                    <label for="${safeId}">${sans}</label>
                `;
                container.appendChild(div);
            });
        }
        
        // Initialize blacklisted sans modal with checkboxes
        function initializeBlacklistedModal() {
            const container = document.getElementById('blacklisted_checkboxes');
            if (!container) return;
            
            container.innerHTML = '';
            
            allSans.forEach(sans => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                const safeId = 'blacklisted_' + sans.replace(/[^a-zA-Z0-9]/g, '_');
                div.innerHTML = `
                    <input type="checkbox" id="${safeId}" ${blacklistedSans.has(sans) ? 'checked' : ''}>
                    <label for="${safeId}">${sans}</label>
                `;
                container.appendChild(div);
            });
        }
        
        // Initialize raw sans modal with checkboxes
        function initializeRawModal() {
            const container = document.getElementById('raw_checkboxes');
            if (!container) return;
            
            container.innerHTML = '';
            
            allSans.forEach(sans => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                const safeId = 'raw_' + sans.replace(/[^a-zA-Z0-9]/g, '_');
                div.innerHTML = `
                    <input type="checkbox" id="${safeId}" ${rawSans.has(sans) ? 'checked' : ''}>
                    <label for="${safeId}">${sans}</label>
                `;
                container.appendChild(div);
            });
        }
        
        // Filter unobtainable sans in modal based on search query
        function filterUnobtainableSans() {
            const query = document.getElementById('unobtainable_search').value.toLowerCase();
            const items = document.querySelectorAll('#unobtainable_checkboxes .checkbox-item');
            
            items.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(query) ? 'flex' : 'none';
            });
        }
        
        // Filter blacklisted sans in modal based on search query
        function filterBlacklistedSans() {
            const query = document.getElementById('blacklisted_search').value.toLowerCase();
            const items = document.querySelectorAll('#blacklisted_checkboxes .checkbox-item');
            
            items.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(query) ? 'flex' : 'none';
            });
        }
        
        // Filter raw sans in modal based on search query
        function filterRawSans() {
            const query = document.getElementById('raw_search').value.toLowerCase();
            const items = document.querySelectorAll('#raw_checkboxes .checkbox-item');
            
            items.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(query) ? 'flex' : 'none';
            });
        }
        
        // Bulk selection functions for unobtainable sans
        function selectAllUnobtainable() {
            document.querySelectorAll('#unobtainable_checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        function deselectAllUnobtainable() {
            document.querySelectorAll('#unobtainable_checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        function invertUnobtainableSelection() {
            document.querySelectorAll('#unobtainable_checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = !checkbox.checked;
            });
        }
        
        // Bulk selection functions for blacklisted sans
        function selectAllBlacklisted() {
            document.querySelectorAll('#blacklisted_checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        function deselectAllBlacklisted() {
            document.querySelectorAll('#blacklisted_checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        function invertBlacklistedSelection() {
            document.querySelectorAll('#blacklisted_checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = !checkbox.checked;
            });
        }
        
        // Bulk selection functions for raw sans
        function selectAllRaw() {
            document.querySelectorAll('#raw_checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        function deselectAllRaw() {
            document.querySelectorAll('#raw_checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        function invertRawSelection() {
            document.querySelectorAll('#raw_checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = !checkbox.checked;
            });
        }
        
        // Save unobtainable sans settings from modal
        function saveUnobtainableSettings() {
            const newUnobtainableSans = new Set();
            document.querySelectorAll('#unobtainable_checkboxes input[type="checkbox"]:checked').forEach(checkbox => {
                const label = checkbox.nextElementSibling.textContent;
                newUnobtainableSans.add(label);
            });
            
            unobtainableSans = newUnobtainableSans;
            console.log("DEBUG: Updated unobtainableSans:", Array.from(unobtainableSans));
            
            closeModal('unobtainableModal');
            alert(`Unobtainable sans settings saved! ${unobtainableSans.size} sans will be excluded.`);
        }
        
        // Save blacklisted sans settings from modal
        function saveBlacklistedSettings() {
            const newBlacklistedSans = new Set();
            document.querySelectorAll('#blacklisted_checkboxes input[type="checkbox"]:checked').forEach(checkbox => {
                const label = checkbox.nextElementSibling.textContent;
                newBlacklistedSans.add(label);
            });
            
            blacklistedSans = newBlacklistedSans;
            console.log("DEBUG: Updated blacklistedSans:", Array.from(blacklistedSans));
            
            closeModal('blacklistedModal');
            alert(`Blacklist settings saved! ${blacklistedSans.size} sans will be hidden from results.`);
        }
        
        // Save raw sans settings from modal
        function saveRawSettings() {
            const newRawSans = new Set();
            document.querySelectorAll('#raw_checkboxes input[type="checkbox"]:checked').forEach(checkbox => {
                const label = checkbox.nextElementSibling.textContent;
                newRawSans.add(label);
            });
            
            rawSans = newRawSans;
            console.log("DEBUG: Updated rawSans:", Array.from(rawSans));
            
            closeModal('rawModal');
            alert(`Raw sans settings saved! ${rawSans.size} sans marked as RAW.`);
        }
        
        // Modal control functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Search functionality for sans selection
        document.getElementById('sans_search').addEventListener('input', async function(e) {
            const query = e.target.value;
            const resultsContainer = document.getElementById('search_results');
            
            if (query.length < 1) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: query})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displaySearchResults(data.results);
                }
            } catch (error) {
                console.error('Search failed:', error);
                // Fallback to client-side search
                const results = allSans.filter(sans => 
                    sans.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 10).map(name => ({name}));
                displaySearchResults(results);
            }
        });
        
        // Display search results in dropdown
        function displaySearchResults(results) {
            const container = document.getElementById('search_results');
            container.innerHTML = '';
            
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.textContent = result.name;
                div.onclick = () => selectSans(result.name);
                container.appendChild(div);
            });
            
            container.style.display = 'block';
        }
        
        // Select a sans from search results
        function selectSans(sansName) {
            if (!selectedSans.has(sansName)) {
                selectedSans.add(sansName);
                updateSelectedSansDisplay();
            }
            
            document.getElementById('sans_search').value = '';
            document.getElementById('search_results').style.display = 'none';
        }
        
        // Remove a sans from selected list
        function removeSans(sansName) {
            selectedSans.delete(sansName);
            updateSelectedSansDisplay();
        }
        
        // Update the display of selected sans
        function updateSelectedSansDisplay() {
            const container = document.getElementById('selected_sans');
            container.innerHTML = '';
            
            selectedSans.forEach(sansName => {
                const div = document.createElement('div');
                div.className = 'selected-sans-item';
                div.innerHTML = `
                    ${sansName}
                    <span class="remove-sans" onclick="removeSans('${sansName}')">×</span>
                `;
                container.appendChild(div);
            });
        }
        
        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('search_results').style.display = 'none';
            }
        });
        
        // Main calculation function
        async function calculate() {
            const loading = document.getElementById('loading');
            const resultsContent = document.getElementById('results-content');
            
            loading.style.display = 'block';
            resultsContent.innerHTML = '';
            
            try {
                // Validate and parse custom sans
                const customSansText = document.getElementById('custom_sans').value;
                let customSans = {};
                if (customSansText.trim()) {
                    try {
                        customSans = JSON.parse(customSansText);
                    } catch (e) {
                        throw new Error(`Invalid custom sans JSON: ${e.message}`);
                    }
                }
                
                // Validate numeric inputs
                const serverLuck = parseInt(document.getElementById('server_luck').value);
                const timeSeconds = parseFloat(document.getElementById('time_seconds').value);
                
                if (isNaN(serverLuck) || serverLuck < 1) {
                    throw new Error('Server Luck must be a number greater than 0');
                }
                if (isNaN(timeSeconds) || timeSeconds <= 0) {
                    throw new Error('Time Period must be a positive number');
                }
                
                // Prepare request data
                const requestData = {
                    server_luck: serverLuck,
                    time_seconds: timeSeconds,
                    custom_sans: customSans,
                    custom_raw: Array.from(rawSans),
                    custom_unobtainable: Array.from(unobtainableSans),
                    custom_blacklisted: Array.from(blacklistedSans),
                    selected_sans: Array.from(selectedSans)
                };
                
                console.log('Sending request:', requestData);
                
                // Make API request with proper error handling
                const response = await fetch('/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                // Check if response is OK
                if (!response.ok) {
                    let errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    
                    // Try to get error details from response
                    try {
                        const errorText = await response.text();
                        if (errorText) {
                            // If it's HTML, extract text content
                            if (errorText.includes('<html') || errorText.includes('<!DOCTYPE')) {
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = errorText;
                                const textContent = tempDiv.textContent || tempDiv.innerText || '';
                                errorMessage += ` - ${textContent.substring(0, 200)}...`;
                            } else {
                                errorMessage += ` - ${errorText.substring(0, 200)}`;
                            }
                        }
                    } catch (e) {
                        // Ignore errors in reading response body
                    }
                    
                    throw new Error(errorMessage);
                }
                
                // Parse JSON response
                const data = await response.json();
                console.log('Received response:', data);
                
                if (data.success) {
                    displayResults(data.results);
                } else {
                    throw new Error(data.error || 'Unknown server error');
                }
                
            } catch (error) {
                console.error('Calculation error:', error);
                resultsContent.innerHTML = `
                    <div style="color: #dc3545; padding: 20px; text-align: center;">
                        <h4>Calculation Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                            Please check your inputs and try again.<br>
                            If the problem persists, check the browser console for details.
                        </p>
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Display calculation results
        function displayResults(results) {
            const content = document.getElementById('results-content');
            let html = '';
            
            // Basic statistics grid
            html += `<div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">${results.total_sans}</div>
                    <div class="stat-label">Total Sans Types</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${results.server_luck}x</div>
                    <div class="stat-label">Server Luck</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatTime(results.time_seconds)}</div>
                    <div class="stat-label">Time Period</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round(results.total_rolls).toLocaleString()}</div>
                    <div class="stat-label">Total Rolls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round(results.total_sans_spawned).toLocaleString()}</div>
                    <div class="stat-label">Total Sans Spawned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${results.time_per_roll.toFixed(2)}s</div>
                    <div class="stat-label">Time per Roll</div>
                </div>
            </div>`;
            
            // Selected sans detailed analysis
            if (Object.keys(results.selected_results).length > 0) {
                html += `<div class="result-card">
                    <h3>Selected Sans Analysis</h3>`;
                
                Object.entries(results.selected_results).forEach(([name, data]) => {
                    const isBlacklisted = results.blacklisted_sans.includes(name);
                    html += `
                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                        <h4>${name} ${data.is_raw ? '<span class="raw-badge">RAW</span>' : ''} ${isBlacklisted ? '<span class="blacklisted-badge">BLACKLISTED</span>' : ''}</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 10px;">
                            <div>
                                <strong>Individual Probability:</strong><br>
                                ${data.individual_probability.toFixed(6)}%
                            </div>
                            <div>
                                <strong>Final Probability:</strong><br>
                                ${data.base_probability.toFixed(6)}%
                            </div>
                            <div>
                                <strong>Probability in ${formatTime(results.time_seconds)}:</strong><br>
                                ${data.probability_percent.toFixed(2)}%
                            </div>
                            <div>
                                <strong>Expected Count:</strong><br>
                                ${data.expected_count.toFixed(4)}
                            </div>
                            <div>
                                <strong>Expected Time for First:</strong><br>
                                ${formatTime(data.time_first)}
                            </div>
                            <div>
                                <strong>Time for 99% Chance:</strong><br>
                                ${formatTime(data.time_99_percent)}
                            </div>
                        </div>
                    </div>`;
                });
                
                html += `</div>`;
            }
            
            // High probability ranking
            html += `<div class="result-card">
                <h3>High Probability Ranking (Top 20)</h3>
                <div class="sans-list">`;
            
            results.sorted_by_prob.forEach(([name, data], index) => {
                const isBlacklisted = results.blacklisted_sans.includes(name);
                if (isBlacklisted) return; // Skip blacklisted sans
                
                html += `<div class="sans-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <strong>${index + 1}. ${name}</strong>
                        <div>
                            ${data.is_raw ? '<span class="raw-badge">RAW</span>' : ''}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="min-width: 80px;">${data.probability_percent.toFixed(2)}%</span>
                        <div class="progress-bar" style="flex: 1;">
                            <div class="progress-fill" style="width: ${Math.min(data.probability_percent, 100)}%"></div>
                        </div>
                    </div>
                </div>`;
            });
            
            html += `</div></div>`;
            
            // Rarest sans ranking
            html += `<div class="result-card">
                <h3>Rarest Sans Ranking (Top 20)</h3>
                <div class="sans-list">`;
            
            results.sorted_by_rarity.forEach(([name, data], index) => {
                const isBlacklisted = results.blacklisted_sans.includes(name);
                if (isBlacklisted) return; // Skip blacklisted sans
                
                html += `<div class="sans-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <strong>${index + 1}. ${name}</strong>
                        <div>
                            ${data.is_raw ? '<span class="raw-badge">RAW</span>' : ''}
                        </div>
                    </div>
                    <div style="color: #666; font-size: 0.9em;">
                        Base Probability: ${data.base_probability.toFixed(6)}% | 
                        Get Probability: ${data.probability_percent.toFixed(4)}%
                    </div>
                </div>`;
            });
            
            html += `</div></div>`;
            
            content.innerHTML = html;
        }
        
        // Helper function to format time in human-readable format
        function formatTime(seconds) {
            if (seconds === Infinity) return '∞';
            if (seconds < 60) return `${seconds.toFixed(1)}s`;
            if (seconds < 3600) return `${(seconds / 60).toFixed(1)}m`;
            if (seconds < 86400) return `${(seconds / 3600).toFixed(1)}h`;
            return `${(seconds / 86400).toFixed(1)}d`;
        }
    </script>
</body>
</html>
